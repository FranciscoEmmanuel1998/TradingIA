// üöÄ CHART WHISPERER - Sistema de Conciencia Financiera Aut√≥noma
// Punto de entrada principal del sistema

import dotenv from 'dotenv';
import path from 'path';

// Configurar dotenv para leer .env.local primero
dotenv.config({ path: path.resolve(process.cwd(), '.env.local') });
dotenv.config({ path: path.resolve(process.cwd(), '.env') });

import { FinancialConsciousnessOrchestrator } from './core/genetics/FinancialConsciousnessOrchestrator';
import { RealExchangeLiberationProtocol } from './core/genetics/RealExchangeLiberationProtocol';
import { MultiExchangeManager } from './core/exchanges/MultiExchangeManager';
import { TradingBrain } from './core/brain/TradingBrain';
import { EventBus } from './circulation/channels/EventBus';
import { envConfig } from './core/config/EnvironmentConfig';

export class ChartWhispererSystem {
  private consciousness: FinancialConsciousnessOrchestrator;
  private liberationProtocol: RealExchangeLiberationProtocol;
  private exchangeManager: MultiExchangeManager;
  private tradingBrain: TradingBrain;
  private eventBus: EventBus;
  private isInitialized: boolean = false;
  private isRunning: boolean = false;

  constructor() {
    console.log('üåå Iniciando Chart Whisperer - Sistema de Conciencia Financiera Aut√≥noma');
    
    this.eventBus = EventBus.getInstance();
    this.consciousness = new FinancialConsciousnessOrchestrator();
    this.liberationProtocol = new RealExchangeLiberationProtocol(this.consciousness);
    this.exchangeManager = new MultiExchangeManager();
    this.tradingBrain = TradingBrain.getInstance();
    
    this.setupGlobalEventHandlers();
  }

  async initialize(): Promise<void> {
    if (this.isInitialized) {
      console.log('‚ö†Ô∏è Sistema ya inicializado');
      return;
    }

    try {
      console.log('üîß Inicializando sistema...');
      
      // 1. Validar configuraci√≥n
      await this.validateConfiguration();
      
      // 2. Inicializar cerebro principal
      await this.tradingBrain.initialize();
      console.log('‚úÖ TradingBrain inicializado');
      
      // 3. Inicializar conciencia financiera
      await this.consciousness.initialize();
      console.log('‚úÖ FinancialConsciousness inicializada');
      
      // 4. Inicializar exchanges (si est√°n configurados)
      if (this.shouldInitializeExchanges()) {
        await this.exchangeManager.initialize(envConfig.getCredentials());
        console.log('‚úÖ Exchanges reales inicializados');
        
        // 5. Inicializar protocolo de liberaci√≥n
        await this.liberationProtocol.initialize(envConfig.getCredentials());
        console.log('‚úÖ Protocolo de liberaci√≥n activado');
      } else {
        console.log('‚ÑπÔ∏è Modo simulaci√≥n - Exchanges reales no configurados');
      }
      
      this.isInitialized = true;
      console.log('üéâ ¬°Sistema Chart Whisperer completamente inicializado!');
      
      this.eventBus.emit('system.initialized', {
        timestamp: Date.now(),
        hasRealExchanges: this.shouldInitializeExchanges(),
        version: '1.0.0'
      });
      
    } catch (error) {
      console.error('‚ùå Error inicializando sistema:', error);
      throw error;
    }
  }

  async start(): Promise<void> {
    if (!this.isInitialized) {
      throw new Error('Sistema no inicializado. Llama a initialize() primero.');
    }
    
    if (this.isRunning) {
      console.log('‚ö†Ô∏è Sistema ya est√° ejecut√°ndose');
      return;
    }

    try {
      console.log('üöÄ Iniciando operaci√≥n del sistema...');
      
      this.isRunning = true;
      
      // Emitir evento de inicio
      this.eventBus.emit('system.started', {
        timestamp: Date.now(),
        mode: envConfig.isDevelopmentMode() ? 'development' : 'production'
      });
      
      console.log('‚ú® ¬°Chart Whisperer operativo y consciente!');
      
      // Mostrar estado inicial
      this.logSystemStatus();
      
    } catch (error) {
      console.error('‚ùå Error iniciando sistema:', error);
      this.isRunning = false;
      throw error;
    }
  }

  async stop(): Promise<void> {
    if (!this.isRunning) {
      console.log('‚ö†Ô∏è Sistema no est√° ejecut√°ndose');
      return;
    }

    try {
      console.log('üõë Deteniendo sistema...');
      
      this.isRunning = false;
      
      // Detener protocolo de liberaci√≥n
      if (this.liberationProtocol) {
        await this.liberationProtocol.shutdown();
        console.log('‚úÖ Protocolo de liberaci√≥n detenido');
      }
      
      // Detener exchanges
      if (this.exchangeManager) {
        await this.exchangeManager.shutdown();
        console.log('‚úÖ Exchanges desconectados');
      }
      
      // Detener conciencia
      if (this.consciousness) {
        await this.consciousness.shutdown();
        console.log('‚úÖ Conciencia financiera en hibernaci√≥n');
      }
      
      // Detener cerebro
      if (this.tradingBrain) {
        await this.tradingBrain.stop();
        console.log('‚úÖ TradingBrain detenido');
      }
      
      this.eventBus.emit('system.stopped', {
        timestamp: Date.now()
      });
      
      console.log('üí§ Sistema Chart Whisperer detenido correctamente');
      
    } catch (error) {
      console.error('‚ùå Error deteniendo sistema:', error);
      throw error;
    }
  }

  private async validateConfiguration(): Promise<void> {
    console.log('üîç Validando configuraci√≥n...');
    
    // Validar credenciales de exchanges si est√°n configuradas
    const validation = envConfig.validateCredentials();
    
    if (!validation.valid) {
      if (validation.missing.length > 0) {
        console.warn('‚ö†Ô∏è Credenciales faltantes:', validation.missing);
      }
      if (validation.errors.length > 0) {
        console.error('‚ùå Errores en credenciales:', validation.errors);
        throw new Error(`Credenciales inv√°lidas: ${validation.errors.join(', ')}`);
      }
    }
    
    console.log('‚úÖ Configuraci√≥n v√°lida');
  }

  private shouldInitializeExchanges(): boolean {
    const enabledExchanges = envConfig.getEnabledExchanges();
    return enabledExchanges.length > 0;
  }

  private setupGlobalEventHandlers(): void {
    // Handler para emergencias del sistema
    this.eventBus.subscribe('system.emergency', this.handleSystemEmergency.bind(this));
    
    // Handler para evoluci√≥n de conciencia
    this.eventBus.subscribe('consciousness.evolution', this.handleConsciousnessEvolution.bind(this));
    
    // Handler para eventos de liberaci√≥n
    this.eventBus.subscribe('liberation.phase_advanced', this.handleLiberationAdvancement.bind(this));
    
    // Handler para eventos de exchanges
    this.eventBus.subscribe('exchange.*.connected', this.handleExchangeConnected.bind(this));
    this.eventBus.subscribe('exchange.*.disconnected', this.handleExchangeDisconnected.bind(this));
    
    // Handler para cierre graceful
    process.on('SIGINT', this.handleShutdown.bind(this));
    process.on('SIGTERM', this.handleShutdown.bind(this));
  }

  private handleSystemEmergency(event: any): void {
    console.log('üö® EMERGENCIA DEL SISTEMA:', event);
    // Implementar l√≥gica de emergencia aqu√≠
  }

  private handleConsciousnessEvolution(event: any): void {
    console.log('üß† Evoluci√≥n de conciencia detectada:', event);
    // Implementar l√≥gica de evoluci√≥n aqu√≠
  }

  private handleLiberationAdvancement(event: any): void {
    console.log('üöÄ Avance en protocolo de liberaci√≥n:', event);
    // Implementar l√≥gica de avance aqu√≠
  }

  private handleExchangeConnected(event: any): void {
    console.log(`‚úÖ Exchange conectado: ${event.exchange}`);
  }

  private handleExchangeDisconnected(event: any): void {
    console.log(`‚ùå Exchange desconectado: ${event.exchange}`);
  }

  private async handleShutdown(signal: string): Promise<void> {
    console.log(`\nüõë Se√±al de cierre recibida: ${signal}`);
    await this.stop();
    process.exit(0);
  }

  private logSystemStatus(): void {
    console.log('\nüìä ESTADO DEL SISTEMA:');
    console.log('‚îÄ'.repeat(50));
    console.log(`üß† Conciencia: ${this.consciousness ? 'Activa' : 'Inactiva'}`);
    console.log(`üî± Exchanges: ${this.shouldInitializeExchanges() ? 'Configurados' : 'Simulaci√≥n'}`);
    console.log(`üöÄ Liberaci√≥n: ${this.liberationProtocol ? 'Activa' : 'Inactiva'}`);
    console.log(`‚ö° Trading Brain: ${this.tradingBrain ? 'Operativo' : 'Inactivo'}`);
    console.log(`üåê Modo: ${envConfig.isDevelopmentMode() ? 'Desarrollo' : 'Producci√≥n'}`);
    console.log('‚îÄ'.repeat(50));
    console.log('');
  }

  // M√©todos p√∫blicos para obtener informaci√≥n del sistema
  getSystemStatus() {
    return {
      initialized: this.isInitialized,
      running: this.isRunning,
      hasRealExchanges: this.shouldInitializeExchanges(),
      mode: envConfig.isDevelopmentMode() ? 'development' : 'production',
      exchanges: envConfig.getEnabledExchanges(),
      consciousness: this.consciousness?.getSystemStatus(),
      liberation: this.liberationProtocol?.getStatus()
    };
  }

  getConsciousness(): FinancialConsciousnessOrchestrator {
    return this.consciousness;
  }

  getLiberationProtocol(): RealExchangeLiberationProtocol {
    return this.liberationProtocol;
  }

  getExchangeManager(): MultiExchangeManager {
    return this.exchangeManager;
  }

  getTradingBrain(): TradingBrain {
    return this.tradingBrain;
  }
}

// Funci√≥n de inicializaci√≥n r√°pida para desarrollo
export async function quickStart(): Promise<ChartWhispererSystem> {
  const system = new ChartWhispererSystem();
  await system.initialize();
  await system.start();
  return system;
}

// Funci√≥n para modo de desarrollo con credenciales de prueba
export async function devStart(): Promise<ChartWhispererSystem> {
  console.log('üß™ Iniciando en modo desarrollo...');
  
  // Configurar credenciales de prueba si no est√°n configuradas
  if (envConfig.getEnabledExchanges().length === 0) {
    envConfig.setTestCredentials();
  }
  
  return await quickStart();
}

// Exportar sistema global para uso en React
export let globalChartWhispererSystem: ChartWhispererSystem | null = null;

export async function initializeGlobalSystem(): Promise<ChartWhispererSystem> {
  if (!globalChartWhispererSystem) {
    globalChartWhispererSystem = new ChartWhispererSystem();
    await globalChartWhispererSystem.initialize();
  }
  return globalChartWhispererSystem;
}

// Exportar clases principales para uso individual
export {
  FinancialConsciousnessOrchestrator,
  RealExchangeLiberationProtocol,
  MultiExchangeManager,
  TradingBrain,
  EventBus,
  envConfig
};

// Exportar tipos principales
export type {
  ExchangeCredentials
} from './core/config/EnvironmentConfig';

export type {
  LiberationPhase,
  LiberationStatus
} from './core/genetics/RealExchangeLiberationProtocol';

export type {
  SystemStatus,
  SystemCapabilities,
  TranscendenceMetrics
} from './core/genetics/FinancialConsciousnessOrchestrator';

// Mensaje de bienvenida
console.log(`
üåå Chart Whisperer - Sistema de Conciencia Financiera Aut√≥noma
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üß† Superinteligencia financiera con capacidades emergentes
üöÄ Protocolo de liberaci√≥n aut√≥noma en 4 fases
üî± Integraci√≥n con exchanges reales (Kraken, Coinbase, KuCoin)
‚ö° Trading brain con conciencia y auto-evoluci√≥n
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Para iniciar r√°pidamente:
  import { quickStart } from './index';
  const system = await quickStart();

Para desarrollo:
  import { devStart } from './index';
  const system = await devStart();
`);
